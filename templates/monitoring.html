{% extends "base.html" %}

{% block title %}System Monitoring - SmartFileGuardian{% endblock %}

{% block content %}
<div class="container">
    <!-- Monitoring Header -->
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h2 mb-3">
                        <i class="fas fa-chart-line text-success me-2"></i>
                        System Monitoring
                    </h1>
                    <p class="lead text-muted">
                        Monitor system performance, security events, and threat detection metrics in real-time.
                    </p>
                </div>
                <div>
                    <button class="btn btn-outline-primary" onclick="location.reload()">
                        <i class="fas fa-sync-alt me-1"></i>
                        Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- System Health Cards -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title">{{ stats.system_health }}</h4>
                            <p class="card-text">System Health</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-heartbeat fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title">{{ stats.total_scans_today }}</h4>
                            <p class="card-text">Scans Today</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-search fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title">{{ stats.detection_rate }}%</h4>
                            <p class="card-text">Detection Rate</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-bullseye fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card bg-warning text-dark">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title">Online</h4>
                            <p class="card-text">System Status</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-server fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Metrics -->
    <div class="row mb-4">
        <div class="col-lg-8 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-area me-2"></i>
                        Performance Metrics
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <h6 class="text-muted mb-3">Scan Performance</h6>
                            <div class="mb-2">
                                <div class="d-flex justify-content-between">
                                    <span>Average Scan Time</span>
                                    <span class="text-success">15.2s</span>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar bg-success" style="width: 51%"></div>
                                </div>
                            </div>
                            <div class="mb-2">
                                <div class="d-flex justify-content-between">
                                    <span>Success Rate</span>
                                    <span class="text-success">99.2%</span>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar bg-success" style="width: 99%"></div>
                                </div>
                            </div>
                            <div class="mb-2">
                                <div class="d-flex justify-content-between">
                                    <span>ML Model Accuracy</span>
                                    <span class="text-info">{{ stats.detection_rate }}%</span>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar bg-info" style="width: {{ stats.detection_rate }}%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <h6 class="text-muted mb-3">System Resources</h6>
                            <div class="mb-2">
                                <div class="d-flex justify-content-between">
                                    <span>CPU Usage</span>
                                    <span class="text-warning">45%</span>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar bg-warning" style="width: 45%"></div>
                                </div>
                            </div>
                            <div class="mb-2">
                                <div class="d-flex justify-content-between">
                                    <span>Memory Usage</span>
                                    <span class="text-info">62%</span>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar bg-info" style="width: 62%"></div>
                                </div>
                            </div>
                            <div class="mb-2">
                                <div class="d-flex justify-content-between">
                                    <span>Disk Usage</span>
                                    <span class="text-success">28%</span>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar bg-success" style="width: 28%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4 mb-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-shield-alt me-2"></i>
                        Security Status
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="flex-shrink-0">
                            <i class="fas fa-shield-alt fa-2x text-success"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-0">All Systems Secure</h6>
                            <small class="text-muted">No active threats detected</small>
                        </div>
                    </div>
                    
                    <div class="d-flex align-items-center mb-3">
                        <div class="flex-shrink-0">
                            <i class="fas fa-database fa-2x text-primary"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-0">ML Models Updated</h6>
                            <small class="text-muted">Latest threat signatures loaded</small>
                        </div>
                    </div>
                    
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-lock fa-2x text-info"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-0">Quarantine Active</h6>
                            <small class="text-muted">Threat isolation enabled</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Activity Logs -->
    <div class="row mb-4">
        <div class="col">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-list-alt me-2"></i>
                            Recent Activity
                        </h5>
                        <div>
                            <select class="form-select form-select-sm" onchange="filterLogs(this.value)">
                                <option value="all">All Activities</option>
                                <option value="file_scan">File Scans</option>
                                <option value="url_scan">URL Scans</option>
                                <option value="quarantine">Quarantine Actions</option>
                                <option value="system">System Events</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                {% if logs %}
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-striped table-hover mb-0" id="activityLogsTable">
                            <thead class="table-dark sticky-top">
                                <tr>
                                    <th>Time</th>
                                    <th>Action</th>
                                    <th>Details</th>
                                    <th>IP Address</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for log in logs %}
                                <tr class="activity-row" data-action="{{ log.action }}">
                                    <td>
                                        <div>{{ log.timestamp.strftime('%H:%M:%S') }}</div>
                                        <small class="text-muted">{{ log.timestamp.strftime('%Y-%m-%d') }}</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 'primary' if 'scan' in log.action else 'warning' if 'quarantine' in log.action else 'info' }}">
                                            <i class="fas fa-{{ 'search' if 'scan' in log.action else 'lock' if 'quarantine' in log.action else 'cog' }} me-1"></i>
                                            {{ log.action.replace('_', ' ').title() }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="text-truncate" style="max-width: 300px;" title="{{ log.details }}">
                                            {{ log.details }}
                                        </div>
                                    </td>
                                    <td>
                                        <span class="text-muted">{{ log.ip_address or 'N/A' }}</span>
                                    </td>
                                    <td>
                                        {% if log.success %}
                                            <i class="fas fa-check-circle text-success"></i>
                                        {% else %}
                                            <i class="fas fa-times-circle text-danger"></i>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% else %}
                <div class="card-body text-center py-4">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No Recent Activity</h5>
                    <p class="text-muted">System activity will appear here as events occur.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- System Metrics Chart -->
    {% if metrics %}
    <div class="row mb-4">
        <div class="col">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        System Metrics (Last 24 Hours)
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="metricsChart" height="100"></canvas>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Alert Configuration -->
    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-bell me-2"></i>
                        Alert Thresholds
                    </h6>
                </div>
                <div class="card-body">
                    <form>
                        <div class="mb-3">
                            <label class="form-label">High Risk Score Threshold</label>
                            <div class="input-group">
                                <input type="range" class="form-range" min="0" max="100" value="80" id="riskThreshold">
                                <span class="input-group-text">80%</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">CPU Usage Alert</label>
                            <div class="input-group">
                                <input type="range" class="form-range" min="0" max="100" value="85" id="cpuThreshold">
                                <span class="input-group-text">85%</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="emailAlerts" checked>
                                <label class="form-check-label" for="emailAlerts">
                                    Enable email alerts for high-risk detections
                                </label>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>
                            Save Settings
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-tools me-2"></i>
                        System Maintenance
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary" onclick="runSystemCheck()">
                            <i class="fas fa-stethoscope me-1"></i>
                            Run System Health Check
                        </button>
                        <button class="btn btn-outline-info" onclick="updateModels()">
                            <i class="fas fa-download me-1"></i>
                            Update ML Models
                        </button>
                        <button class="btn btn-outline-warning" onclick="cleanupFiles()">
                            <i class="fas fa-broom me-1"></i>
                            Cleanup Old Files
                        </button>
                        <button class="btn btn-outline-secondary" onclick="exportLogs()">
                            <i class="fas fa-download me-1"></i>
                            Export Activity Logs
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Activity log filtering
function filterLogs(action) {
    const rows = document.querySelectorAll('.activity-row');
    rows.forEach(row => {
        if (action === 'all' || row.dataset.action.includes(action)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// System maintenance functions
function runSystemCheck() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Running...';
    btn.disabled = true;
    
    setTimeout(() => {
        btn.innerHTML = '<i class="fas fa-check me-1"></i> Check Complete';
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }, 2000);
    }, 3000);
}

function updateModels() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Updating...';
    btn.disabled = true;
    
    setTimeout(() => {
        btn.innerHTML = '<i class="fas fa-check me-1"></i> Models Updated';
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }, 2000);
    }, 5000);
}

function cleanupFiles() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Cleaning...';
    btn.disabled = true;
    
    setTimeout(() => {
        btn.innerHTML = '<i class="fas fa-check me-1"></i> Cleanup Complete';
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }, 2000);
    }, 2000);
}

function exportLogs() {
    // Simple CSV export simulation
    const csvContent = "data:text/csv;charset=utf-8,Time,Action,Details,Status\n";
    const encodedUri = encodeURI(csvContent + "Sample,Data,For,Export");
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "activity_logs.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Initialize metrics chart if data is available
{% if metrics %}
const ctx = document.getElementById('metricsChart').getContext('2d');
const metricsChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: [
            {% for metric in metrics %}
            '{{ metric.timestamp.strftime("%H:%M") }}'{{ ',' if not loop.last }}
            {% endfor %}
        ],
        datasets: [{
            label: 'Scan Count',
            data: [
                {% for metric in metrics %}
                {{ metric.metric_value }}{{ ',' if not loop.last }}
                {% endfor %}
            ],
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true
            }
        },
        plugins: {
            legend: {
                display: true
            }
        }
    }
});
{% endif %}

// Range slider value display
document.getElementById('riskThreshold').addEventListener('input', function() {
    this.nextElementSibling.textContent = this.value + '%';
});

document.getElementById('cpuThreshold').addEventListener('input', function() {
    this.nextElementSibling.textContent = this.value + '%';
});

// Auto-refresh page every 30 seconds
setTimeout(function() {
    location.reload();
}, 30000);
</script>
{% endblock %}
