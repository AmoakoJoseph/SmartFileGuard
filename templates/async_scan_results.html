{% extends "base.html" %}

{% block title %}Scan in Progress - SmartFileGuard{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col">
            <h1 class="h2 mb-3">
                <i class="fas fa-spinner fa-spin me-2"></i>
                Scan in Progress
            </h1>
            <p class="lead text-muted">
                Your {{ scan_type }} scan{{ 's' if tasks|length > 1 else '' }} {{ 'are' if tasks|length > 1 else 'is' }} being processed in real-time. 
                Progress updates will appear below.
            </p>
        </div>
    </div>

    <!-- Progress Cards -->
    <div class="row" id="progressContainer">
        {% for task in tasks %}
        <div class="col-12 mb-4">
            <div class="card" id="task-{{ task.task_id }}">
                <div class="card-header bg-info text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-{{ 'file' if scan_type == 'file' else 'globe' }} me-2"></i>
                            {% if scan_type == 'file' %}
                                {{ task.filename }}
                            {% else %}
                                {{ task.url }}
                            {% endif %}
                        </h5>
                        <span class="badge bg-light text-dark">Processing</span>
                    </div>
                </div>
                
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span>Progress:</span>
                            <span class="progress-text">0%</span>
                        </div>
                        <div class="progress progress-bar-container" style="height: 25px;">
                            <div class="progress-bar bg-info progress-bar-animated progress-bar-striped" 
                                 role="progressbar" 
                                 style="width: 0%"
                                 aria-valuenow="0" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                0%
                            </div>
                        </div>
                    </div>
                    
                    <div class="status-message">
                        <i class="fas fa-hourglass-half me-2"></i>
                        <span>Initializing scan...</span>
                    </div>
                    
                    <!-- Results will be populated here -->
                    <div class="scan-results" style="display: none;">
                        <hr>
                        <div class="results-content"></div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- Connection Status -->
    <div class="row mt-4">
        <div class="col">
            <div class="alert alert-info" id="connectionStatus">
                <i class="fas fa-wifi me-2"></i>
                <span>Connecting to real-time updates...</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const socket = io();
    const tasks = {{ tasks | tojson | safe }};
    const connectionStatus = document.getElementById('connectionStatus');
    
    // Connection event handlers
    socket.on('connect', function() {
        connectionStatus.innerHTML = '<i class="fas fa-check me-2"></i><span>Connected to real-time updates</span>';
        connectionStatus.className = 'alert alert-success';
        
        // Join scan rooms for each task
        tasks.forEach(function(task) {
            socket.emit('join_scan_room', {scan_id: task.task_id});
        });
    });
    
    socket.on('disconnect', function() {
        connectionStatus.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i><span>Disconnected from real-time updates</span>';
        connectionStatus.className = 'alert alert-warning';
    });
    
    // Scan progress updates
    socket.on('scan_progress', function(data) {
        updateProgress(data);
    });
    
    // Connection confirmation
    socket.on('connection_confirmed', function(data) {
        console.log('WebSocket connected:', data);
    });
    
    function updateProgress(data) {
        const taskCard = document.getElementById('task-' + data.scan_id);
        if (!taskCard) return;
        
        const progressBar = taskCard.querySelector('.progress-bar');
        const progressText = taskCard.querySelector('.progress-text');
        const statusMessage = taskCard.querySelector('.status-message');
        const badge = taskCard.querySelector('.badge');
        
        // Update progress bar
        progressBar.style.width = data.progress + '%';
        progressBar.setAttribute('aria-valuenow', data.progress);
        progressBar.textContent = data.progress + '%';
        progressText.textContent = data.progress + '%';
        
        // Update status message
        statusMessage.innerHTML = '<i class="fas fa-cog fa-spin me-2"></i><span>' + data.message + '</span>';
        
        // Handle completion
        if (data.progress >= 100) {
            progressBar.classList.remove('progress-bar-animated', 'progress-bar-striped');
            
            if (data.data && data.data.threat_level) {
                const threatLevel = data.data.threat_level;
                const threatColors = {
                    'safe': 'success',
                    'suspicious': 'warning', 
                    'malicious': 'danger'
                };
                
                const color = threatColors[threatLevel] || 'secondary';
                progressBar.className = 'progress-bar bg-' + color;
                badge.className = 'badge bg-' + color;
                badge.textContent = threatLevel.charAt(0).toUpperCase() + threatLevel.slice(1);
                
                statusMessage.innerHTML = '<i class="fas fa-check-circle me-2"></i><span>Scan completed</span>';
                
                // Show results
                displayResults(taskCard, data.data);
            }
        }
    }
    
    function displayResults(taskCard, results) {
        const resultsContainer = taskCard.querySelector('.scan-results');
        const resultsContent = taskCard.querySelector('.results-content');
        
        let html = '<h6><i class="fas fa-clipboard-list me-2"></i>Scan Results</h6>';
        
        if (results.threat_level === 'safe') {
            html += '<div class="alert alert-success"><i class="fas fa-shield-alt me-2"></i>No threats detected</div>';
        } else {
            html += '<div class="alert alert-' + (results.threat_level === 'suspicious' ? 'warning' : 'danger') + '">';
            html += '<i class="fas fa-exclamation-triangle me-2"></i>';
            html += 'Threat Level: ' + results.threat_level.charAt(0).toUpperCase() + results.threat_level.slice(1);
            html += '</div>';
        }
        
        html += '<div class="row">';
        html += '<div class="col-md-6">';
        html += '<strong>Risk Score:</strong> ' + (results.risk_score * 100).toFixed(1) + '%<br>';
        html += '<strong>File Hash:</strong> <code>' + (results.file_hash ? results.file_hash.substring(0, 16) + '...' : 'N/A') + '</code><br>';
        html += '</div>';
        html += '<div class="col-md-6">';
        html += '<strong>Scan Time:</strong> ' + new Date(results.scan_timestamp).toLocaleString() + '<br>';
        html += '<strong>Quarantined:</strong> ' + (results.quarantined ? 'Yes' : 'No');
        html += '</div>';
        html += '</div>';
        
        if (results.detection_details && results.detection_details.length > 0) {
            html += '<hr><h6>Detection Details:</h6>';
            html += '<ul class="list-unstyled">';
            results.detection_details.forEach(function(detail) {
                html += '<li><i class="fas fa-info-circle me-2"></i>' + detail + '</li>';
            });
            html += '</ul>';
        }
        
        resultsContent.innerHTML = html;
        resultsContainer.style.display = 'block';
    }
    
    // Fallback polling for task status (if WebSocket fails)
    function pollTaskStatus() {
        tasks.forEach(function(task) {
            if (task.status === 'processing') {
                fetch('/api/task-status/' + task.task_id)
                    .then(response => response.json())
                    .then(data => {
                        if (data.state === 'SUCCESS' && data.result) {
                            // Simulate progress update
                            updateProgress({
                                scan_id: task.task_id,
                                progress: 100,
                                message: 'Scan completed',
                                data: data.result
                            });
                            task.status = 'completed';
                        }
                    })
                    .catch(console.error);
            }
        });
        
        // Continue polling if any tasks are still processing
        const stillProcessing = tasks.some(task => task.status === 'processing');
        if (stillProcessing) {
            setTimeout(pollTaskStatus, 5000);
        }
    }
    
    // Start fallback polling after a delay
    setTimeout(pollTaskStatus, 10000);
});
</script>
{% endblock %}